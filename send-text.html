<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Send Text</title>

    <script type="text/javascript" src="/quiet.js"></script>
    <script>
      Quiet.init({
        profilesPrefix: "/",
        memoryInitializerPrefix: "/",
        libfecPrefix: "/"
    });
    </script>
    <script async type="text/javascript" src="/quiet-emscripten.js"></script>
  </head>
  <body>

    <h2>Send Text</h2>
    
    <h4>Select a profile:</h4>
    <select  id="quiet-profile"><option value="cable-64k">cable-64k</option></select>
    <h4>Text to send:</h4>
    <textarea rows="10" cols = "100" id = 'quiet-text'></textarea>
    <br><button  style="padding: 5px 20px;" id="quiet-btn" disabled = 'true'>Send</button>
    <h4>Status:</h4>
    <p id = 'quiet-status'>waiting onQuietReady...</p>
    <h4>Error:</h4>
    <p id = 'quiet-errors'></p>
    
    <script>
/*
      var globalElementText;
      var globalElementStatus;
      var globalElementErrors;     
      var globalElementBtnSend;   */
      var globalTransmiter = null;
      //var globalProfilename;


      var globalElementText = document.getElementById("quiet-text");
      var globalElementStatus = document.getElementById("quiet-status");
      var globalElementErrors = document.getElementById("quiet-errors");       
      var globalElementBtnSend = document.getElementById("quiet-btn");            
      var globalElementProfile = document.getElementById("quiet-profile");   

      populateDropdown() ;
      
      Quiet.addReadyCallback(onQuietReady, onQuietFail);
      
      globalElementBtnSend.addEventListener('click', function () {

        //globalProfilename = document.getElementById("quiet-profile").value;
        if (globalElementProfile.value === '') {window.alert('please select a profile.'); return;} 
        if (globalElementText.value === '') {window.alert('please enter text to send.'); return;} 
        
        globalElementBtnSend.disabled = true;
        
        globalElementStatus.textContent = 'sending...';
        
        if (globalTransmiter !== null) {
          globalTransmiter.destroy();
          globalTransmiter = null;
        } 
        globalTransmiter = Quiet.transmitter({profile: globalElementProfile.value, onFinish: onTransmitFinish});
        globalTransmiter.transmit(Quiet.str2ab(globalElementText.value));
      });


      async function onQuietReady() {
          globalElementBtnSend.disabled = false;
          globalElementStatus.textContent = 'please choose a profile, enter text, click button to send.';        
      };
      
      
      function onTransmitFinish() {
          //textbox.focus();
          globalElementStatus.textContent = 'send finished.';          
          globalElementBtnSend.disabled = false;
      };

      function onQuietFail(reason) {
          console.log("quiet failed to initialize: " + reason);
          globalElementErrors.textContent += "\r\nSorry, it looks like there was a problem with this example (" + reason + ")";
      };

      async function populateDropdown() {
        try {
            const response = await fetch('quiet-profiles.json');
            const data = await response.json(); // Parse the JSON data

            for (const key in data) {
              //console.log(key);
                const option = document.createElement('option');
                option.value = key; // Set the value attribute
                option.textContent = key; // Set the visible text
                globalElementProfile.appendChild(option); // Add the option to the select element
            }
        } catch (error) {
            console.error('An error occurred fetching the JSON:', error);
        }
      }     

    </script>
  </body>
</html>
