<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>receive binary data via sound</title>

    <script type="text/javascript" src="/quiet.js"></script>
   <script>
		Quiet.init({
		    profilesPrefix: "/",
		    memoryInitializerPrefix: "/",
		    libfecPrefix: "/"
		});
    </script>
    <script async type="text/javascript" src="/quiet-emscripten.js"></script>
  </head>
  <body>
    <h2>Receive file</h2>
    <h4>Select a profile:</h4>
    <select id="quiet-profile"><option value="cable-64k">cable-64k</option></select>
    <button id='quiet-btn' style="padding: 5px 20px;" disabled = 'true' > Receive file </button>
    <h4>Status:</h4>
    <p id = 'quiet-status'>waiting onQuietReady...</p>
    <h4>File info</h4>
    name:&nbsp;<span id = 'quiet-name'></span>
    &emsp;size:&nbsp;<span id = 'quiet-size'></span>   
    &emsp;hash:&nbsp;<span id = 'quiet-hash'></span>      

    <h4>Error:</h4>
    <p id = 'quiet-errors'></p>
    
  <script>
  /*
    var globalElementStatus;
    var globalElementErrors;     
    var globalElementBtn; 
    var globalElementHash;
    var globalElementName;
    var globalElementSize;     */
    var globalReceiver = null;
    //var globalProfilename;
    var globalPayload = new ArrayBuffer(0);
    var globalTimerId;
    
    var globalElementStatus = document.getElementById("quiet-status");
    var globalElementErrors = document.getElementById("quiet-errors");       
    var globalElementBtn = document.getElementById("quiet-btn");          
    var globalElementName = document.getElementById("quiet-name");
    var globalElementSize = document.getElementById("quiet-size");       
    var globalElementHash = document.getElementById("quiet-hash"); 
    var globalElementProfile = document.getElementById("quiet-profile");     
    populateDropdown() ;
          
    Quiet.addReadyCallback(onQuietReady, onQuietFail);

    globalElementBtn.addEventListener('click',  function () {
      //var profilename = 'cable-64k';
      //var profilename = 'audible';
      
      //globalProfilename = document.getElementById("quiet-profile").value;
      if (globalElementProfile.value === '') {window.alert('please select a profile.'); return;} 
      
      globalReceiver = Quiet.receiver({profile: globalElementProfile.value,
         onReceive: onReceive,
         onCreateFail: onReceiverCreateFail,
         onReceiveFail: onReceiveFail
      });
      globalElementStatus.textContent = 'Please send file in sender end.';
      this.disabled = true;
    });
    function onQuietFail(reason) {
      //window.alert('onQuietFail	');
      //console.log("quiet failed to initialize: " + reason);
      globalElementErrors.textContent   += ( '\r\nonQuietFail:'  + reason);
      //document.getElementById('receive-status').textContent = globalErrmsg;
      //document.getElementById('receive-button').disabled = false;
    };

    function onQuietReady() {
      //window.alert('ready');
      globalElementStatus.textContent = 'Please press button to receive.';
      globalElementBtn.disabled=false;
      //window.alert('onQuietReady');
    };
    function onReceive(recvPayload) {
      clearTimeout(globalTimerId);
      var d = new Date();
      var ms = d.getMilliseconds();

      if (globalElementName.innerText === '') {
        globalElementStatus.textContent =  d.toString() + '.' + ms.toString() + ': Got filename.';
        globalElementName.innerText = Quiet.ab2str(recvPayload);
      } else if (globalElementSize.innerText === '') {
        globalElementStatus.textContent =  d.toString() + '.' + ms.toString() + ': Got size.';
        globalElementSize.innerText = Quiet.ab2str(recvPayload);
      } else if (globalElementHash.innerText === '') {
        globalElementStatus.textContent =  d.toString() + '.' + ms.toString() + ': Got hash.';
        globalElementHash.innerText = Quiet.ab2str(recvPayload);
      } else {
        globalElementStatus.textContent =  d.toString() + '.' + ms.toString() + ': Got file data trunck.';
        globalPayload = Quiet.mergeab(globalPayload, recvPayload);
      }
      //window.alert('onReceive');
      globalTimerId = setTimeout(stopReceive, 3000);
    };
    async function stopReceive() {
      clearTimeout(globalTimerId);
      globalReceiver.destroy();
      globalElementStatus.textContent = '超过3秒未有收到信号，视同传输结束, verify hash...';
      var filehash = await hashArrayBuffer(globalPayload);
      if (filehash === globalElementHash.innerText) {
         globalElementStatus.textContent = 'hash verify successful.downloading...reflesh page for next receive.';       

         const blob = new Blob([globalPayload]);
         const url = URL.createObjectURL(blob);
         const link = document.createElement('a');
         link.href = url;
         link.setAttribute('download', globalElementName.innerText);
         document.body.appendChild(link);
         link.click();
         document.body.removeChild(link);
         URL.revokeObjectURL(url);
      } else {
         globalElementStatus.textContent = 'hash verify failed.';                 
      }

   }
    function onReceiverCreateFail(reason) {
      //window.alert('onReceiverCreateFail');
      //console.log("failed to create quiet receiver: " + reason);
      //document.getElementById('receive-status').textContent =
      globalElementErrors.textContent   +=( '\r\nonReceiverCreateFail:' +  reason + ', maybe:  it looks like this example is not supported by your browser. Please give permission to use the microphone or try again in Google Chrome or Microsoft Edge.');
      //document.getElementById('receive-button').disabled = false;
    };

    function onReceiveFail(num_fails) {
      //window.alert('onReceiveFail');
      globalElementErrors.textContent +=( '\r\nonReceiveFail:' +  'maybe:  We did not quite get that. It looks like you tried to transmit something. You may need to move the transmitter closer to the receiver and set the volume to 50%.');
      //document.getElementById('receive-button').disabled = false;
    };

    async function hashArrayBuffer(buffer) {
      // Generate the hash
      const hashBuffer = await crypto.subtle.digest('SHA-256', buffer); // returns a Promise<ArrayBuffer>
      // Convert the ArrayBuffer to a Uint8Array for easier processing
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      // Convert the bytes to a hexadecimal string
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }
    async function populateDropdown() {
      try {
          const response = await fetch('quiet-profiles.json');
          const data = await response.json(); // Parse the JSON data

          for (const key in data) {
            //console.log(key);
              const option = document.createElement('option');
              option.value = key; // Set the value attribute
              option.textContent = key; // Set the visible text
              globalElementProfile.appendChild(option); // Add the option to the select element
          }
      } catch (error) {
          console.error('An error occurred fetching the JSON:', error);
      }
    }  
  </script>
  </body>
</html>
