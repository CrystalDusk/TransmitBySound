<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Receive Text</title>

    <script type="text/javascript" src="/quiet.js"></script>
   <script>
		Quiet.init({
		    profilesPrefix: "/",
		    memoryInitializerPrefix: "/",
		    libfecPrefix: "/"
		});
    </script>
    <script async type="text/javascript" src="/quiet-emscripten.js"></script>
  </head>
  <body>

    <h2>Receive text</h2>
    <h4>Select a profile:</h4>
    <select id="quiet-profile"><option value="cable-64k">cable-64k</option></select>
    <button id='quiet-btn' style="padding: 5px 20px;" disabled = 'true' > Receive text </button>
    <h4>Text received:</h4>
    <textarea rows="10" cols = "100" id = 'quiet-text'></textarea>
    <h4>Status:</h4>
    <p id = 'quiet-status'>waiting onQuietReady...</p>
    <h4>Error:</h4>
    <p id = 'quiet-errors'></p>

    <script>
    
      //var globalElementText;
      //var globalElementStatus;
      //var globalElementErrors;     
      //var globalElementBtn;   
      var globalReceiver = null;
      //var globalProfilename;

      var globalElementText = document.getElementById("quiet-text");
      var globalElementStatus = document.getElementById("quiet-status");
      var globalElementErrors = document.getElementById("quiet-errors");       
      var globalElementBtn = document.getElementById("quiet-btn");            
      var globalElementProfile = document.getElementById("quiet-profile");   

      populateDropdown() ;
      //window.alert('addEventListener_click');	
      Quiet.addReadyCallback(onQuietReady, onQuietFail);
      //globalElementStatus.textContent = 'waiting onQuietReady';

      globalElementBtn.addEventListener('click',  function () {
          //var profilename = 'cable-64k';
          //var profilename = 'audible';
        //globalProfilename = document.getElementById("quiet-profile").value;
        //window.alert('ahaha');
        if (globalElementProfile.value === '') {
          window.alert('please select a profile.'); 
          return;
        } 
        
        globalReceiver = Quiet.receiver({profile: globalElementProfile.value,
           onReceive: onReceive,
           onCreateFail: onReceiverCreateFail,
           onReceiveFail: onReceiveFail
        });
        globalElementStatus.textContent = 'Please send text in sender end.';
        this.disabled = true;
      });
      function onQuietFail(reason) {
        //window.alert('onQuietFail	');
        //console.log("quiet failed to initialize: " + reason);
        globalElementErrors.textContent +=  ('\r\nonQuietFail:'  + reason);
        //document.getElementById('receive-status').textContent = globalErrmsg;
        //document.getElementById('receive-button').disabled = false;
      };

      function onQuietReady() {
        //window.alert('ready');
        globalElementStatus.textContent = 'Please press button to receive.';
        globalElementBtn.disabled=false;
        //window.alert('onQuietReady');
      };
    function onReceive(recvPayload) {
  
      var d = new Date();
      var ms = d.getMilliseconds();
 
      globalElementStatus.textContent =  d.toString() + '.' + ms.toString() + ': Got data trunck.';
      globalElementText.value += Quiet.ab2str(recvPayload)
      //window.alert('onReceive');

    };
    
    function onReceiverCreateFail(reason) {
      //window.alert('onReceiverCreateFail');
      //console.log("failed to create quiet receiver: " + reason);
      //document.getElementById('receive-status').textContent =
      globalElementErrors.textContent += ( '\r\nonReceiverCreateFail:' +  reason + ', maybe:  it looks like this example is not supported by your browser. Please give permission to use the microphone or try again in Google Chrome or Microsoft Edge.');
      //document.getElementById('receive-button').disabled = false;
    };

    function onReceiveFail(num_fails) {
      //window.alert('onReceiveFail');
      globalElementErrors.textContent += ( '\r\nonReceiveFail:' +  'maybe:  We did not quite get that. It looks like you tried to transmit something. You may need to move the transmitter closer to the receiver and set the volume to 50%.');
      //document.getElementById('receive-button').disabled = false;
    };
    async function populateDropdown() {
      try {
          const response = await fetch('quiet-profiles.json');
          const data = await response.json(); // Parse the JSON data

          for (const key in data) {
            //console.log(key);
              const option = document.createElement('option');
              option.value = key; // Set the value attribute
              option.textContent = key; // Set the visible text
              globalElementProfile.appendChild(option); // Add the option to the select element
          }
      } catch (error) {
          console.error('An error occurred fetching the JSON:', error);
      }
    }  


  </script>
  </body>
</html>
