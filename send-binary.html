<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Send bianry data via sound.</title>

    <script type="text/javascript" src="/quiet.js"></script>
    <script>
       Quiet.init({
          profilesPrefix: "/",
          memoryInitializerPrefix: "/",
          libfecPrefix: "/"
      });
    </script>
    <script async type="text/javascript" src="/quiet-emscripten.js"></script>
  </head>
  <body>
    <h2>Send file</h2>
    <h4>Select a profile:</h4>
    <select id="quiet-profile"><option value="cable-64k">cable-64k</option></select>
    <h4>Choose a file to send:</h4>      
    <input type="file" id="quiet-file" disabled = 'true'>
    <button  style="padding: 5px 20px;" id="quiet-btn" disabled = 'true'>Send</button>    
    <h4>Status:</h4>
    <p id = 'quiet-status'>waiting onQuietReady...</p>
    <h4>File hash:</h4>
    <p id="quiet-hash"></p>
    <h4>Error:</h4>
    <p id = 'quiet-errors'></p>
      

    
    <script>
    /*
      var globalElementFileInput;
      var globalElementHash;
      var globalElementStatus;
      var globalElementErrors;   
      var globalElementBtnSend;*/
      
      var globalFile = null;
      var globalFileArrayBuffer;
      //var globalProfilename = ''; 
      
      var globalTransmiter = null;   

      
      var globalElementFileInput = document.getElementById('quiet-file');
      var globalElementStatus = document.getElementById('quiet-status');
      var globalElementErrors= document.getElementById('quiet-errors');
      var globalElementHash= document.getElementById('quiet-hash');
      var globalElementProfile = document.getElementById("quiet-profile");   
      var globalElementBtnSend = document.getElementById("quiet-btn");      
      
      populateDropdown() ;
      Quiet.addReadyCallback(onQuietReady, onQuietFail);   
      
      
      globalElementFileInput.addEventListener('change', async function(e) {
        globalFile = e.target.files[0];
        if (!globalFile) return;
        this.disabled = true;
        
        globalElementStatus.textContent = 'reading file...';
        globalFileArrayBuffer = await globalFile.arrayBuffer();
        globalElementStatus.textContent = 'calculating hash...';
        globalElementHash.textContent = await hashArrayBuffer(globalFileArrayBuffer);

        //window.alert(hash);
        globalElementBtnSend.disabled = false;
        globalElementStatus.textContent = 'please click button to send.';
      });
        
      globalElementBtnSend.addEventListener('click', function () { 
      
        globalProfilename = document.getElementById("quiet-profile").value;
      
        if (globalElementProfile.value === '') {window.alert('please select a profile.'); return;} 
        if (globalFile === null) {window.alert('please choose a file.'); return;} 
        
        globalElementFileInput.disabled = true;
        globalElementBtnSend.disabled = true;
        globalElementStatus.textContent =  'sending filename...';
        globalTransmiter = Quiet.transmitter({profile: globalElementProfile.value, onFinish: function() {onTransmitFinish(1)}});
        globalTransmiter.transmit(Quiet.str2ab(globalFile.name)); 
      });

      function onTransmitFinish(stage) {
        console.log(stage);
        globalTransmiter.destroy();
        globalTransmiter = null;
        if (stage===1) {
          globalElementStatus.textContent =  'sending file size...';
          globalTransmiter = Quiet.transmitter({profile: globalProfilename, onFinish: function() {onTransmitFinish(2)}});      
          globalTransmiter.transmit(Quiet.str2ab(String(globalFile.size)));            
        } else if (stage===2) {
          globalElementStatus.textContent =  'sending hash...';
          globalTransmiter = Quiet.transmitter({profile: globalProfilename, onFinish: function() {onTransmitFinish(3)}});      
          globalTransmiter.transmit(Quiet.str2ab(globalElementHash.textContent));            
        } else if (stage===3) {
          globalElementStatus.textContent =  'sending file data...';
          globalTransmiter = Quiet.transmitter({profile: globalProfilename, onFinish: function() {onTransmitFinish(4)}});      
          globalTransmiter.transmit(globalFileArrayBuffer);            
        } else if (stage==4) {
           globalElementStatus.textContent =  'send finished.';
        }

      }
      function onQuietReady() {
          globalElementFileInput.disabled = false;
          globalElementStatus.textContent = 'please select a profile, choose a file to send.';
      };

      function onQuietFail(reason) {
          console.log("quiet failed to initialize: " + reason);
          globalErrmsg.textContent += "\r\nSorry, it looks like there was a problem with this example (" + reason + ")";
      };
      
   
     async function hashArrayBuffer(buffer) {
        // Generate the hash
        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer); // returns a Promise<ArrayBuffer>
        // Convert the ArrayBuffer to a Uint8Array for easier processing
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        // Convert the bytes to a hexadecimal string
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }
    
    async function populateDropdown() {
        try {
            const response = await fetch('quiet-profiles.json');
            const data = await response.json(); // Parse the JSON data

            for (const key in data) {
              //console.log(key);
                const option = document.createElement('option');
                option.value = key; // Set the value attribute
                option.textContent = key; // Set the visible text
                globalElementProfile.appendChild(option); // Add the option to the select element
            }
        } catch (error) {
            console.error('An error occurred fetching the JSON:', error);
        }
      }   
      
    </script>

  </body>
  
</html>
